<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>LED/Button FSM Demo</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 40px; }
        .led {
            width: 60px; height: 60px; border-radius: 50%;
            margin: 20px auto; background: #222;
            box-shadow: 0 0 20px #000;
            opacity: 0.4;
            transition: opacity 0.1s;
        }
        button { margin: 8px; padding: 10px 20px; font-size: 1.1em; }
    </style>
</head>
<body>
    <h1>LED/Button FSM Demo</h1>
    <div id="led" class="led"></div>
    <div>
        <button onclick="setState('BOOTING')">BOOTING</button>
        <button onclick="setState('IDLE')">IDLE</button>
        <button onclick="setState('CARD_READ')">CARD_READ</button>
        <button onclick="setState('LOADING')">LOADING</button>
        <button onclick="setState('PLAYING')">PLAYING</button>
        <button onclick="setState('PAUSED')">PAUSED</button>
        <button onclick="setState('LONG_PRESS')">LONG_PRESS</button>
        <button onclick="setState('END')">END</button>
        <button onclick="setState('ERROR')">ERROR</button>
    </div>
    <h2>Stato attuale: <span id="state"></span></h2>
    <script>
let state = "IDLE";
let led = document.getElementById('led');
let stateSpan = document.getElementById('state');
let timer = null;
let frame = null;
let blinkCount = 0;

function clearTimers() {
    if (timer) {
        clearTimeout(timer);
        timer = null;
    }
    if (frame) {
        cancelAnimationFrame(frame);
        frame = null;
    }
}

function setState(newState) {
    state = newState;
    stateSpan.textContent = state;
    clearTimers();
    led.style.background = "#fff";
    led.style.opacity = 0.15; // Default for IDLE
    runState();
}

function runState() {
    switch(state) {
        case "BOOTING":
            breathing(3, 1.0); // 4s cycle (2s in, 2s out)
            break;
        case "IDLE":
            led.style.opacity = 0.15;
            break;
        case "CARD_READ":
            blinkPattern(2, 50, 150, () => setState("IDLE"));
            break;
        case "LOADING":
            breathing(1, 1.0); // 1s cycle (0.5s in, 0.5s out)
            break;
        case "PLAYING":
            breathing(8, 0.8); // 2s cycle (0.5s in, 0.5s out)
            break;
        case "PAUSED":
            breathing(2.5, 1); // 2s cycle (1s in, 1s out), max 60%
            break;
        case "LONG_PRESS":
            breathing(1, 1.0);
            timer = setTimeout(() => setState("IDLE"), 2000);
            break;
        case "END":
            blinkPattern(3, 100, 250, () => setState("IDLE"));
            break;
        case "ERROR":
            blinkPattern(Infinity, 62.5, 62.5);
            timer = setTimeout(() => setState("IDLE"), 3000);
            break;
    }
}

function breathing(period_s, maxOpacity) {
    let period = period_s * 1000;
    let start = Date.now();
    function animate() {
        let t = ((Date.now() - start) % period) / period;
        // Breathing: opacity from 0.1 to maxOpacity
        let op = 0.1 + (maxOpacity - 0.1) * 0.5 * (1 - Math.cos(2 * Math.PI * t));
        led.style.opacity = op;
        if (state === getCurrentState()) frame = requestAnimationFrame(animate);
    }
    animate();
}

function blinkPattern(times, onMs, offMs, callback) {
    blinkCount = 0;
    function blink() {
        if (times !== Infinity && blinkCount >= times) {
            led.style.opacity = 0.15; // Return to IDLE dim
            if (callback) callback();
            return;
        }
        led.style.opacity = 1.0;
        timer = setTimeout(() => {
            led.style.opacity = 0.15;
            blinkCount++;
            timer = setTimeout(blink, offMs);
        }, onMs);
    }
    blink();
}

function getCurrentState() {
    return state;
}

// Initialize
setState("IDLE");
</script>
</body>
</html>